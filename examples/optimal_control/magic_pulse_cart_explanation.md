# Analysis of `magic_pulse_cart.m` and its relation to the Khaneja/Glaser Paper

This document explains the connection between the Spinach example script `magic_pulse_cart.m` and the scientific paper "Optimal control design of constant amplitude phase-modulated pulses: Application to calibration-free broadband excitation" by T.E. Skinner, N. Khaneja, S.J. Glaser, et al. (*J. Magn. Reson.* **179**, 241-249, 2006).

The paper describes a method based on optimal control theory (specifically the GRAPE algorithm) to design broadband NMR pulses that are robust to variations in RF field strength (B1 inhomogeneity) and resonance offset. The script `magic_pulse_cart.m` implements this general idea using the Spinach library to create a "magic pulse" with similar properties.

While the paper focuses on a *purely phase-modulated* pulse (constant RF amplitude), the script optimizes the *Cartesian components* (X and Y) of the RF field. However, the underlying mathematical framework and the goal are the same.

## Mapping between the Paper and the Code

The following table details the correspondence between the key elements of the Matlab script and the concepts presented in the paper.

| Code (`magic_pulse_cart.m`)                                | Paper Concept / Equation                                     | Explanation                                                                                                                                                                                                                                                                                                 |
| ---------------------------------------------------------- | ------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `sys.magnet=28.18;`                                        | (Not directly in paper)                                      | Sets the static magnetic field. This is a necessary parameter for any NMR simulation, as it defines the Larmor frequency.                                                                                                                                                                                           |
| `inter.zeeman.scalar=num2cell(linspace(-100,100,n_spins));` | Resonance Offset `Δω` in Eq. (2)                             | This line creates a simulation with 100 spins, each having a different chemical shift. This corresponds to designing the pulse to be effective over a wide range of resonance offsets, a key goal of the paper.                                                                                                 |
| `control.pwr_levels=2*pi*linspace(50e3,70e3,10);`           | RF Amplitude `ω₁` in Eq. (2)                                 | This defines a range of RF field strengths (from 50 to 70 kHz). The optimization algorithm will produce a single pulse that works well across this entire range, achieving the "calibration-free" aspect described in the paper.                                                                                |
| `control.pulse_dt=1e-6*ones(1,40);`                          | Pulse duration `t_p` and time steps                        | This sets the total duration of the pulse (40 * 1µs = 40 µs) and the number of time steps. The optimization finds the RF values for each of these discrete time points.                                                                                                                                          |
| `control.rho_init={ Sx Sy Sz};`                             | Initial Magnetization `M(t₀)`                                | These are the starting states for the optimization. The script optimizes for three different starting states simultaneously (`Lx`, `Ly`, and `Lz`).                                                                                                                                                              |
| `control.rho_targ={-Sz Sy Sx};`                              | Target State `F`                                             | These are the corresponding desired final states. The combination of `rho_init` and `rho_targ` defines the overall transformation that the pulse should perform (a complex rotation). The paper's primary example is a simpler `Iz -> Ix` excitation.                                                     |
| `H=hamiltonian(assume(spin_system,'nmr'));`                 | Drift Hamiltonian `Δω Iz`                                    | This specifies the part of the Hamiltonian that is not controlled by the RF pulse—in this case, the chemical shift offsets. This is the `Δω` term in the effective field `ω_eff` from Eq. (2).                                                                                                                   |
| `control.operators={Lx,Ly};`                                | RF Field `ω_rf(t)` in Eq. (2)                                | These are the operators that represent the RF pulse controls. The optimization algorithm finds the time-dependent amplitudes for `Lx` and `Ly` that best achieve the target transformation. These correspond to `ω₁(t)cos(φ(t))` and `ω₁(t)sin(φ(t))`.                                                       |
| `xy_profile=fminnewton(spin_system,@grape_xy,guess);`        | Numerical Algorithm (Section 2.2)                            | This is the core of the script. It calls Spinach's `fminnewton` optimizer, which in turn uses the `@grape_xy` function. This function implements the GRAPE (Gradient Ascent Pulse Engineering) algorithm described in the paper. It iteratively evolves the system, calculates the gradient of the performance metric (cost function), and updates the pulse waveform (`xy_profile`) to maximize performance. |
| `shaped_pulse_xy(...)`                                     | Bloch Equation `M_dot = ω × M` (Eq. 1)                       | After the optimal pulse has been found, this function simulates its effect by solving the Bloch equation for the given pulse waveform and spin system.                                                                                                                                                          |
| Comparison plots at the end                                | Figure 2                                                     | The script simulates the result of the optimized pulse and a standard "hard" pulse and plots their spectra. This directly corresponds to the comparisons shown in Figure 2 of the paper, which demonstrate the superior performance of the optimal control pulse.                                            |

## Summary

The `magic_pulse_cart.m` script is a practical implementation of the principles of quantum optimal control for NMR pulse design, as laid out in the 2006 paper by Khaneja, Glaser, and colleagues. It uses the GRAPE algorithm to find a pulse sequence that is robust over a wide range of experimental imperfections (chemical shift, B1 field strength), faithfully translating the theoretical concepts from the paper into a working simulation using the Spinach library.
